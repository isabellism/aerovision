<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AeroVision 1.5 - Flight Instructor</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; display: flex; }
        .viewport { width: 50vw; height: 100vh; position: relative; overflow: hidden; border-right: 1px solid #333; }
        video.webcam { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; transform: translate(-50%, -50%); object-fit: cover; z-index: 1; }
        a-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; }
        #btn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: #00AAFF; color: white; border: none; border-radius: 10px; z-index: 9999; font-weight: bold; cursor: pointer;}
    </style>
</head>
<body>

    <button id="btn">INICIAR MISSÃO TÉCNICA</button>

    <div class="viewport">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-sphere id="reset-left" position="-1.2 1.1 -2.5" radius="0.08" color="#FF4B4B"><a-text value="RESET" align="center" position="0 -0.15 0" width="1.5"></a-text></a-sphere>
            
            <a-text id="timer-left" value="TEMPO: 00s" position="0.8 1.1 -2.5" align="center" width="2" color="#00FF00"></a-text>
            <a-text id="error-left" value="ERROS: 0" position="0.8 0.95 -2.5" align="center" width="2" color="#FF0000"></a-text>
            
            <a-text id="txt-left" value="PASSO 1: ENCAIXE O EIXO" position="0 0.9 -2.5" align="center" width="2.5" color="#FFF"></a-text>
            
            <a-entity id="p1-left" position="-0.7 0 -2.5" rotation="0 0 90"><a-cylinder id="c1-left" color="#777" height="0.6" radius="0.05"></a-cylinder></a-entity>
            <a-entity id="b1-left" position="0.7 -0.2 -2.5" rotation="0 0 90"><a-cylinder color="#FFF" height="0.6" radius="0.06" opacity="0.2"></a-cylinder></a-entity>
            <a-entity id="p2-left" position="-0.7 0 -2.5" visible="false"><a-torus id="c2-left" color="#00AAFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0"></a-torus></a-entity>
            <a-entity id="b2-left" position="0.7 -0.2 -2.5" visible="false"><a-torus color="#FFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0" opacity="0.2"></a-torus></a-entity>

            <a-sphere id="finger-left" radius="0.05" color="red" position="10 10 10"></a-sphere>
            <a-light type="ambient" intensity="1.2"></a-light>
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <div class="viewport" style="border-right: none;">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-sphere id="reset-right" position="-1.2 1.1 -2.5" radius="0.08" color="#FF4B4B"><a-text value="RESET" align="center" position="0 -0.15 0" width="1.5"></a-text></a-sphere>
            <a-text id="timer-right" value="TEMPO: 00s" position="0.8 1.1 -2.5" align="center" width="2" color="#00FF00"></a-text>
            <a-text id="error-right" value="ERROS: 0" position="0.8 0.95 -2.5" align="center" width="2" color="#FF0000"></a-text>
            
            <a-text id="txt-right" value="PASSO 1: ENCAIXE O EIXO" position="0 0.9 -2.5" align="center" width="2.5" color="#FFF"></a-text>
            <a-entity id="p1-right" position="-0.7 0 -2.5" rotation="0 0 90"><a-cylinder id="c1-right" color="#777" height="0.6" radius="0.05"></a-cylinder></a-entity>
            <a-entity id="b1-right" position="0.7 -0.2 -2.5" rotation="0 0 90"><a-cylinder color="#FFF" height="0.6" radius="0.06" opacity="0.2"></a-cylinder></a-entity>
            <a-entity id="p2-right" position="-0.7 0 -2.5" visible="false"><a-torus id="c2-right" color="#00AAFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0"></a-torus></a-entity>
            <a-entity id="b2-right" position="0.7 -0.2 -2.5" visible="false"><a-torus color="#FFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0" opacity="0.2"></a-torus></a-entity>
            <a-sphere id="finger-right" radius="0.05" color="red" position="10 10 10"></a-sphere>
            <a-light type="ambient" intensity="1.2"></a-light>
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <script>
        const btn = document.getElementById('btn');
        const videos = document.querySelectorAll('.webcam');
        const fingers = [document.getElementById('finger-left'), document.getElementById('finger-right')];
        const texts = [document.getElementById('txt-left'), document.getElementById('txt-right')];
        const timerTexts = [document.getElementById('timer-left'), document.getElementById('timer-right')];
        const errorTexts = [document.getElementById('error-left'), document.getElementById('error-right')];

        let currentStep = 1; let isGrabbing = false; let isSnapped = false;
        let errors = 0; let startTime = 0; let timerInterval;
        const initialPos = { x: -0.7, y: 0, z: -2.5 };
        let partPos = { ...initialPos };
        const basePos = { x: 0.7, y: -0.2, z: -2.5 };

        // Som de Feedback
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq;
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const index = hand[8]; const thumb = hand[4];
                const posX = (index.x - 0.5) * 4; const posY = (0.5 - index.y) * 2.8;
                const pinch = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));
                
                fingers.forEach(f => f.setAttribute('position', `${posX} ${posY} -2.2`));

                if (posX < -0.9 && posY > 0.8 && pinch < 0.1) resetSimulation();
                if (!isSnapped) handleStep(posX, posY, pinch);
            }
        });

        function handleStep(x, y, p) {
            const prefix = currentStep === 1 ? 'p1' : 'p2';
            const baseId = currentStep === 1 ? 'b1' : 'b2';
            const distToPart = Math.sqrt(Math.pow(x - partPos.x, 2) + Math.pow(y - partPos.y, 2));
            const targets = [document.getElementById(prefix + '-left'), document.getElementById(prefix + '-right')];
            const bases = [document.getElementById(baseId + '-left'), document.getElementById(baseId + '-right')];
            const distToBase = Math.sqrt(Math.pow(partPos.x - basePos.x, 2) + Math.pow(partPos.y - basePos.y, 2));

            if (p < 0.1 && distToPart < 0.5) {
                isGrabbing = true;
                partPos.x = x; partPos.y = y;
                targets.forEach(t => t.setAttribute('position', `${x} ${y} ${partPos.z}`));
            } else if (isGrabbing) {
                isGrabbing = false;
                if (distToBase < 0.35) snapPiece(targets);
                else {
                    errors++;
                    errorTexts.forEach(et => et.setAttribute('value', `ERROS: ${errors}`));
                    playSound(150, 'sawtooth', 0.3); // Som de Erro
                    triggerError(targets);
                }
            }
        }

        function triggerError(targets) {
            texts.forEach(t => { t.setAttribute('value', 'ALERTA: POSICAO INCORRETA'); t.setAttribute('color', '#FF4B4B'); });
            partPos = { ...initialPos };
            targets.forEach(t => t.setAttribute('position', `${initialPos.x} ${initialPos.y} ${initialPos.z}`));
            setTimeout(() => { if (!isSnapped) { 
                const msg = currentStep === 1 ? "PASSO 1: ENCAIXE O EIXO" : "PASSO 2: INSTALE A CARCACA";
                texts.forEach(t => { t.setAttribute('value', msg); t.setAttribute('color', '#FFF'); });
            }}, 1200);
        }

        function snapPiece(targets) {
            isSnapped = true;
            playSound(800, 'sine', 0.2); // Som de Sucesso
            targets.forEach(t => t.setAttribute('position', `${basePos.x} ${basePos.y} -2.5`));
            
            setTimeout(() => {
                if (currentStep === 1) {
                    currentStep = 2; isSnapped = false; partPos = { ...initialPos };
                    texts.forEach(t => t.setAttribute('value', 'PASSO 2: INSTALE A CARCACA'));
                    toggleVisibility(['p2', 'b2'], true); toggleVisibility(['b1'], false);
                } else {
                    clearInterval(timerInterval);
                    texts.forEach(t => t.setAttribute('value', 'MISSAO COMPLETA!'));
                    const finalTime = Math.floor((Date.now() - startTime)/1000);
                    setTimeout(() => alert(`Relatório ORBITA:\nTempo: ${finalTime}s\nErros: ${errors}`), 500);
                }
            }, 800);
        }

        function resetSimulation() {
            errors = 0; currentStep = 1; isSnapped = false; isGrabbing = false; 
            startTime = Date.now();
            partPos = { ...initialPos };
            errorTexts.forEach(et => et.setAttribute('value', `ERROS: 0`));
            resetPositions();
            toggleVisibility(['p2', 'b2'], false); toggleVisibility(['b1'], true);
        }

        function resetPositions() {
            const p1 = [document.getElementById('p1-left'), document.getElementById('p1-right')];
            p1.forEach(p => p.setAttribute('position', '-0.7 0 -2.5'));
            const p2 = [document.getElementById('p2-left'), document.getElementById('p2-right')];
            p2.forEach(p => { p.setAttribute('position', '-0.7 0 -2.5'); p.setAttribute('visible', 'false'); });
            texts.forEach(t => { t.setAttribute('value', 'PASSO 1: ENCAIXE O EIXO'); t.setAttribute('color', '#FFF'); });
        }

        function toggleVisibility(ids, state) {
            ids.forEach(id => {
                document.getElementById(id + '-left').setAttribute('visible', state);
                document.getElementById(id + '-right').setAttribute('visible', state);
            });
        }

        async function loop() {
            if (videos[0].readyState >= 2) {
                await hands.send({image: videos[0]});
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timerTexts.forEach(tt => tt.setAttribute('value', `TEMPO: ${elapsed}s`));
            }
            requestAnimationFrame(loop);
        }

        btn.addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            videos.forEach(v => { v.srcObject = stream; v.play(); });
            btn.style.display = 'none';
            startTime = Date.now();
            setTimeout(loop, 1000);
        });
    </script>
</body>
</html>
