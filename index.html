<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÓRBITA VR 6.0 - Intermediário Fluido</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; }
video { display:none; }
#startBtn {
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  padding:20px 40px;
  background:#00AAFF;
  border:none;
  color:#fff;
  font-size:18px;
  border-radius:10px;
  z-index:999;
}
</style>
</head>

<body>

<button id="startBtn">INICIAR VR</button>
<video id="webcam" autoplay playsinline muted></video>

<a-scene embedded vr-mode-ui="enabled:false">

<a-assets>
  <!-- PRONTO PARA MODELOS 3D FUTUROS -->
  <!-- <a-asset-item id="parafusoModel" src="models/parafuso.glb"></a-asset-item> -->
</a-assets>

<a-entity id="cameraRig" position="0 1.6 0">
  <a-camera></a-camera>
  <a-sphere id="cursor" radius="0.03" color="white" position="0 0 -1.5"></a-sphere>
</a-entity>

<a-light type="ambient" intensity="0.6"></a-light>
<a-light type="directional" position="1 2 1" intensity="1.2"></a-light>

<a-plane rotation="-90 0 0" width="10" height="10" color="#111"></a-plane>

<!-- OBJETOS -->
<a-box id="cubo" position="-0.6 1 -2" scale="0.2 0.2 0.2" color="#FF4B4B"></a-box>
<a-sphere id="esfera" position="0 1 -2" radius="0.12" color="#00AAFF"></a-sphere>
<a-cone id="cone" position="0.6 1 -2" radius-bottom="0.15" height="0.25" color="#32CD32"></a-cone>

</a-scene>

<script>

// =========================
// CONFIGURAÇÃO MEDIAPIPE
// =========================

const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0, // mais leve
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

// =========================
// OBJETOS CACHEADOS
// =========================

const objects = {
  cubo: document.querySelector("#cubo"),
  esfera: document.querySelector("#esfera"),
  cone: document.querySelector("#cone")
};

const cursor = document.querySelector("#cursor");

let activeObject = null;
let isPinching = false;
let isScaling = false;

let smooth = 0.12;

// =========================
// ESTADO DOS OBJETOS
// =========================

let state = {
  cubo: { x:-0.6, y:1, z:-2, rot:0, scale:1 },
  esfera:{ x:0, y:1, z:-2, rot:0, scale:1 },
  cone:{ x:0.6, y:1, z:-2, rot:0, scale:1 }
};

// =========================
// HAND TRACKING
// =========================

hands.onResults(results => {

  if (!results.multiHandLandmarks) return;

  const hand = results.multiHandLandmarks[0];

  const x = (hand[8].x - 0.5) * 4;
  const y = (0.5 - hand[8].y) * 3;

  cursor.setAttribute("position", `${x} ${y} -1.5`);

  const pinchDist = Math.hypot(
    hand[4].x - hand[8].x,
    hand[4].y - hand[8].y
  );

  const scaleDist = Math.hypot(
    hand[4].x - hand[12].x,
    hand[4].y - hand[12].y
  );

  isPinching = pinchDist < 0.07;
  isScaling = pinchDist < 0.07 && scaleDist < 0.07;

  if (!activeObject) {
    let closest = null;
    let minDist = 0.5;

    for (let key in state) {
      let d = Math.hypot(x - state[key].x, y - state[key].y);
      if (d < minDist) {
        minDist = d;
        closest = key;
      }
    }

    if (closest && isPinching) {
      activeObject = closest;
    }
  }

  if (activeObject) {

    if (isScaling) {
      state[activeObject].scale += (0.5 - hand[0].y) * 0.02;
      state[activeObject].scale = Math.max(0.3, Math.min(2, state[activeObject].scale));
    } 
    else if (isPinching) {
      state[activeObject].x = x;
      state[activeObject].y = y;
    } 
    else {
      activeObject = null;
    }
  }

});

// =========================
// LOOP PRINCIPAL ÚNICO
// =========================

let lastTime = 0;
const video = document.getElementById("webcam");

function animate(time) {

  if (time - lastTime > 33) { // 30fps MediaPipe
    if (video.readyState >= 2) {
      hands.send({ image: video });
    }
    lastTime = time;
  }

  for (let key in state) {

    const obj = objects[key];
    const s = state[key];

    const currentPos = obj.getAttribute("position");

    s.x += (s.x - currentPos.x) * smooth;
    s.y += (s.y - currentPos.y) * smooth;

    obj.setAttribute("position", `${s.x} ${s.y} ${s.z}`);
    obj.setAttribute("rotation", `0 ${s.rot} 0`);

    if (key === "esfera") {
      obj.setAttribute("radius", 0.12 * s.scale);
    } else {
      obj.setAttribute("scale", `${0.2*s.scale} ${0.2*s.scale} ${0.2*s.scale}`);
    }
  }

  requestAnimationFrame(animate);
}

// =========================
// START
// =========================

document.getElementById("startBtn").addEventListener("click", async () => {

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;
  document.getElementById("startBtn").style.display = "none";

  animate();

});

</script>

</body>
</html>
