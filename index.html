<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ORBITA - Manipulação Livre</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; display: flex; width: 100vw; height: 100vh; }
        .viewport { flex: 1; height: 100vh; position: relative; overflow: hidden; border-right: 1px solid #333; }
        video.webcam { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; pointer-events: none; }
        a-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        #start-btn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px 50px; background: #00AAFF; color: white; border: none; border-radius: 15px; z-index: 10000; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <button id="start-btn">INICIAR SANDBOX 3D</button>

    <div class="viewport">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-entity camera position="-0.035 1.6 0" look-controls="enabled: false">
                <a-text class="action-txt" value="MAO LIVRE" position="0 0.7 -2" align="center" width="2.5" color="#FFF"></a-text>
                <a-sphere class="cursor" radius="0.03" color="white" position="10 10 -1.5"></a-sphere>
            </a-entity>

            <a-entity position="0 1 -2.5">
                <a-box position="-0.8 -0.5 0" scale="0.2 0.2 0.2" color="white" opacity="0.3"></a-box>
                <a-sphere position="0 -0.5 0" radius="0.12" color="white" opacity="0.3"></a-sphere>
                <a-cone position="0.8 -0.5 0" radius-bottom="0.15" height="0.25" segments-radial="4" color="white" opacity="0.3"></a-cone>

                <a-box class="obj-cubo" position="-0.8 0.5 0" scale="0.2 0.2 0.2" color="#FF4B4B"></a-box>
                <a-sphere class="obj-esfera" position="0 0.5 0" radius="0.12" color="#00AAFF"></a-sphere>
                <a-cone class="obj-piramide" position="0.8 0.5 0" radius-bottom="0.15" height="0.25" segments-radial="4" color="#32CD32"></a-cone>
                
                <a-grid material="opacity: 0.15; color: #555" position="0 -0.6 0"></a-grid>
            </a-entity>
            <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>
            <a-light type="ambient" intensity="0.6"></a-light>
        </a-scene>
    </div>

    <div class="viewport" style="border-right: none;">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-entity camera position="0.035 1.6 0" look-controls="enabled: false">
                <a-text class="action-txt" value="MAO LIVRE" position="0 0.7 -2" align="center" width="2.5" color="#FFF"></a-text>
                <a-sphere class="cursor" radius="0.03" color="white" position="10 10 -1.5"></a-sphere>
            </a-entity>

            <a-entity position="0 1 -2.5">
                <a-box position="-0.8 -0.5 0" scale="0.2 0.2 0.2" color="white" opacity="0.3"></a-box>
                <a-sphere position="0 -0.5 0" radius="0.12" color="white" opacity="0.3"></a-sphere>
                <a-cone position="0.8 -0.5 0" radius-bottom="0.15" height="0.25" segments-radial="4" color="white" opacity="0.3"></a-cone>

                <a-box class="obj-cubo" position="-0.8 0.5 0" scale="0.2 0.2 0.2" color="#FF4B4B"></a-box>
                <a-sphere class="obj-esfera" position="0 0.5 0" radius="0.12" color="#00AAFF"></a-sphere>
                <a-cone class="obj-piramide" position="0.8 0.5 0" radius-bottom="0.15" height="0.25" segments-radial="4" color="#32CD32"></a-cone>
                
                <a-grid material="opacity: 0.15; color: #555" position="0 -0.6 0"></a-grid>
            </a-entity>
            <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>
            <a-light type="ambient" intensity="0.6"></a-light>
        </a-scene>
    </div>

    <script>
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        // Estado inicial das peças
        let pieces = {
            'cubo': { x: -0.8, y: 0.5, rX: 0, rY: 0, scale: 0.2, targetX: -0.8, isSnapped: false },
            'esfera': { x: 0, y: 0.5, rX: 0, rY: 0, scale: 0.12, targetX: 0, isSnapped: false },
            'piramide': { x: 0.8, y: 0.5, rX: 0, rY: 0, scale: 1, targetX: 0.8, isSnapped: false } // escala da piramide é gerenciada pela tag em si, usaremos multiplicador
        };

        let activePiece = null;
        let actionState = "LIVRE";

        hands.onResults((res) => {
            if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) {
                document.querySelectorAll('.cursor').forEach(c => c.setAttribute('position', `10 10 -1.5`));
                updateHUD("MAO LIVRE", "#FFF");
                return;
            }

            const h = res.multiHandLandmarks[0];
            const x = (h[8].x - 0.5) * 4; 
            const y = (0.5 - h[8].y) * 3;
            
            document.querySelectorAll('.cursor').forEach(c => c.setAttribute('position', `${x} ${y} -1.5`));

            // Distâncias dos dedos (Pinças)
            const dIndex = Math.hypot(h[4].x - h[8].x, h[4].y - h[8].y);   // Dedão + Indicador (MOVER)
            const dMiddle = Math.hypot(h[4].x - h[12].x, h[4].y - h[12].y); // Dedão + Dedo Médio (RODAR)
            const dRing = Math.hypot(h[4].x - h[16].x, h[4].y - h[16].y);   // Dedão + Anelar (ZOOM)

            // Descobrir qual peça está mais perto da mão
            if (actionState === "LIVRE") {
                let closest = null; let minDist = 0.6;
                for (const key in pieces) {
                    const d = Math.hypot(x - pieces[key].x, y - pieces[key].y);
                    if (d < minDist) { minDist = d; closest = key; }
                }
                activePiece = closest;
            }

            if (!activePiece || pieces[activePiece].isSnapped) return;

            const p = pieces[activePiece];

            // AÇÕES BASEADAS NO DEDO
            if (dIndex < 0.08) {
                // MOVER
                actionState = "MOVENDO";
                updateHUD(`MOVENDO: ${activePiece.toUpperCase()}`, "#00AAFF");
                p.x = x; p.y = y;
                updateVisuals();
                
            } else if (dMiddle < 0.08) {
                // RODAR (Baseado na posição X da mão)
                actionState = "RODANDO";
                updateHUD(`RODANDO: ${activePiece.toUpperCase()}`, "#FFD700");
                p.rY = x * 100; // Multiplicador para girar rápido
                p.rX = y * 100;
                updateVisuals();

            } else if (dRing < 0.08) {
                // ZOOM (Baseado na posição Y da mão)
                actionState = "ZOOM";
                updateHUD(`ESCALA: ${activePiece.toUpperCase()}`, "#FF4B4B");
                // Baseado na altura da mão, muda a escala (Limitado para não sumir ou estourar a tela)
                let newScale = Math.max(0.5, Math.min(2.5, 1 + y));
                updateScale(activePiece, newScale);
                
            } else {
                // SOLTOU
                if (actionState === "MOVENDO") {
                    // Verifica Snap
                    const dTarget = Math.hypot(p.x - p.targetX, p.y - (-0.5));
                    if (dTarget < 0.3) {
                        p.x = p.targetX; p.y = -0.5; p.rX = 0; p.rY = 0; p.isSnapped = true;
                        updateScale(activePiece, 1); // Volta ao normal no encaixe
                        updateVisuals();
                        updateHUD("ENCAIXADO!", "#32CD32");
                    }
                }
                actionState = "LIVRE";
                updateHUD("MAO LIVRE", "#FFF");
            }
        });

        function updateVisuals() {
            for (const key in pieces) {
                const p = pieces[key];
                document.querySelectorAll(`.obj-${key}`).forEach(el => {
                    el.setAttribute('position', `${p.x} ${p.y} 0`);
                    el.setAttribute('rotation', `${p.rX} ${p.rY} 0`);
                });
            }
        }

        function updateScale(key, mult) {
            const baseScales = { 'cubo': 0.2, 'esfera': 0.12, 'piramide': 1 };
            const finalScale = baseScales[key] * mult;
            
            document.querySelectorAll(`.obj-${key}`).forEach(el => {
                if(key === 'cubo') el.setAttribute('scale', `${finalScale} ${finalScale} ${finalScale}`);
                if(key === 'esfera') el.setAttribute('radius', `${finalScale}`);
                if(key === 'piramide') {
                    el.setAttribute('radius-bottom', `${0.15 * mult}`);
                    el.setAttribute('height', `${0.25 * mult}`);
                }
            });
        }

        function updateHUD(txt, color) {
            document.querySelectorAll('.action-txt').forEach(el => {
                el.setAttribute('value', txt);
                el.setAttribute('color', color);
            });
        }

        document.getElementById('start-btn').addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.querySelectorAll('.webcam').forEach(v => { v.srcObject = stream; v.play(); });
            document.getElementById('start-btn').style.display = 'none';
            const vid = document.querySelectorAll('.webcam')[0];
            function run() { if (vid.readyState >= 2) hands.send({image: vid}); requestAnimationFrame(run); }
            run();
        });
    </script>
</body>
</html>
