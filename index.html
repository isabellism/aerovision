<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ORBITA - Inspeção Aeroespacial</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    body { margin: 0; overflow: hidden; background: #000; font-family: 'Share Tech Mono', monospace; user-select: none; }
    video { display: none; }
    
    /* TELA DE INÍCIO */
    #startBtn {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        padding: 20px 40px; background: rgba(0, 170, 255, 0.2); border: 2px solid #00AAFF;
        color: #00AAFF; font-size: 18px; border-radius: 5px; z-index: 9999;
        font-family: 'Share Tech Mono', monospace; cursor: pointer; text-transform: uppercase;
        box-shadow: 0 0 15px rgba(0, 170, 255, 0.5); transition: 0.3s;
    }
    #startBtn:active { background: #00AAFF; color: #000; }

    /* HUD (HEADS-UP DISPLAY) AEROESPACIAL */
    #hud {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        pointer-events: none; z-index: 1000; display: none;
        box-sizing: border-box; border: 2px solid rgba(0, 170, 255, 0.3);
    }
    
    .hud-corner { position: absolute; width: 30px; height: 30px; border: 3px solid #00AAFF; }
    .tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .tr { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .bl { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    #status-box {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6); border: 1px solid #00AAFF; padding: 10px 20px;
        color: #00AAFF; font-size: 1.2rem; text-align: center; border-radius: 4px;
        text-shadow: 0 0 5px #00AAFF; letter-spacing: 2px;
    }

    #telemetry {
        position: absolute; bottom: 20px; left: 20px;
        background: rgba(0, 0, 0, 0.5); border-left: 3px solid #00AAFF;
        padding: 10px; color: #fff; font-size: 0.9rem; line-height: 1.5;
    }
    .val { color: #00AAFF; font-weight: bold; }
</style>
</head>

<body>

<button id="startBtn">INICIAR DIAGNÓSTICO ORBITA</button>

<div id="hud">
    <div class="hud-corner tl"></div><div class="hud-corner tr"></div>
    <div class="hud-corner bl"></div><div class="hud-corner br"></div>
    <div id="status-box">SCANNER ATIVO</div>
    <div id="telemetry">
        <div>MODO: <span id="modo-txt" class="val">AGUARDANDO MÃO</span></div>
        <div>ESCALA: <span id="scale-txt" class="val">1.00x</span></div>
        <div>EIXO Y (Giro): <span id="rot-txt" class="val">0.0°</span></div>
        <div>ALVO TRAVADO: <span class="val">20MM_HEX_SCREW</span></div>
    </div>
</div>

<video id="webcam" autoplay playsinline muted></video>

<a-scene embedded vr-mode-ui="enabled:false">
    <a-assets>
        <a-asset-item id="parafuso-glb" src="assets/20mm_hex4gon_screw_with_nut.glb"></a-asset-item>
    </a-assets>

    <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera look-controls="enabled: false"></a-camera>
        <a-ring radius-inner="0.015" radius-outer="0.02" color="#00AAFF" position="0 0 -1" opacity="0.5"></a-ring>
        <a-sphere id="cursor" radius="0.02" color="#FF0055" position="10 10 -1.5" material="emissive: #FF0055; emissiveIntensity: 2"></a-sphere>
    </a-entity>

    <a-light type="ambient" color="#224455" intensity="1.5"></a-light>
    <a-light type="directional" color="#ffffff" position="1 3 2" intensity="2.5"></a-light>
    <a-light type="point" color="#00AAFF" position="-1 1 -1" intensity="1"></a-light>

    <a-entity position="0 1 -2.5">
        <a-cylinder radius="0.8" height="0.05" position="0 -0.5 0" color="#00AAFF" wireframe="true" opacity="0.3"></a-cylinder>
        <a-circle radius="0.6" position="0 -0.49 0" rotation="-90 0 0" color="#00AAFF" opacity="0.1"></a-circle>
        
        <a-entity id="meu-parafuso" gltf-model="#parafuso-glb" position="0 0 0" scale="1 1 1"></a-entity>
    </a-entity>

</a-scene>

<script>
const hands = new Hands({ locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

const obj = document.querySelector("#meu-parafuso");
const cursor = document.querySelector("#cursor");

// DOM do HUD
const hudStatus = document.getElementById("status-box");
const txtModo = document.getElementById("modo-txt");
const txtScale = document.getElementById("scale-txt");
const txtRot = document.getElementById("rot-txt");

// FÍSICA LERP
let state = {
    curX: 0, curY: 0, curRot: 0, curScale: 1,
    tarX: 0, tarY: 0, tarRot: 0, tarScale: 1
};

let isManipulating = false;
let initialHandAngle = 0, initialObjRotation = 0;
let initialHandY = 0, initialObjScale = 1;

hands.onResults(results => {
    if (!results.multiHandLandmarks) {
        cursor.setAttribute("position", `10 10 -1.5`);
        txtModo.innerText = "STANDBY";
        txtModo.style.color = "#888";
        hudStatus.style.borderColor = "#00AAFF";
        hudStatus.style.boxShadow = "0 0 5px #00AAFF";
        isManipulating = false;
        return;
    }

    const hand = results.multiHandLandmarks[0];
    const x = (hand[8].x - 0.5) * 4;
    const y = (0.5 - hand[8].y) * 3;
    cursor.setAttribute("position", `${x} ${y} -1.5`);

    const pinchDist = Math.hypot(hand[4].x - hand[8].x, hand[4].y - hand[8].y);
    const middleDist = Math.hypot(hand[4].x - hand[12].x, hand[4].y - hand[12].y);

    const isPinching = pinchDist < 0.08 && middleDist > 0.1; 
    const isThreeFingers = pinchDist < 0.08 && middleDist < 0.08; 

    if (isThreeFingers) {
        if (!isManipulating) {
            isManipulating = true;
            initialHandAngle = Math.atan2(hand[17].y - hand[5].y, hand[17].x - hand[5].x);
            initialObjRotation = state.tarRot;
            initialHandY = hand[0].y; 
            initialObjScale = state.tarScale;
            hudStatus.style.borderColor = "#FFD700";
            hudStatus.style.boxShadow = "0 0 15px #FFD700";
        }
        txtModo.innerText = "ANÁLISE ESTRUTURAL (Giro/Zoom)";
        txtModo.style.color = "#FFD700";
        
        let currentHandAngle = Math.atan2(hand[17].y - hand[5].y, hand[17].x - hand[5].x);
        state.tarRot = initialObjRotation - ((currentHandAngle - initialHandAngle) * (180 / Math.PI) * 1.5);
        
        let scaleMultiplier = 1 + ((hand[0].y - initialHandY) * -3.0); 
        state.tarScale = initialObjScale * Math.max(0.1, Math.min(10.0, scaleMultiplier));

    } else if (isPinching) {
        txtModo.innerText = "REPOSICIONAMENTO";
        txtModo.style.color = "#FF0055";
        hudStatus.style.borderColor = "#FF0055";
        hudStatus.style.boxShadow = "0 0 15px #FF0055";
        state.tarX = x; state.tarY = y;
        isManipulating = false;
    } else {
        txtModo.innerText = "RASTREIO ATIVO";
        txtModo.style.color = "#00AAFF";
        hudStatus.style.borderColor = "#00AAFF";
        hudStatus.style.boxShadow = "0 0 5px #00AAFF";
        isManipulating = false;
    }
});

// MOTOR DE FÍSICA E ATUALIZAÇÃO DA TELEMETRIA
const smooth = 0.15;
function animate() {
    state.curX += (state.tarX - state.curX) * smooth;
    state.curY += (state.tarY - state.curY) * smooth;
    state.curRot += (state.tarRot - state.curRot) * smooth;
    state.curScale += (state.tarScale - state.curScale) * smooth;

    obj.setAttribute("position", `${state.curX} ${state.curY} 0`);
    obj.setAttribute("rotation", `0 ${state.curRot} 0`); 
    obj.setAttribute("scale", `${state.curScale} ${state.curScale} ${state.curScale}`);

    // Atualiza os dados na tela do HUD
    txtScale.innerText = state.curScale.toFixed(2) + "x";
    txtRot.innerText = (state.curRot % 360).toFixed(1) + "°";

    requestAnimationFrame(animate);
}

document.getElementById("startBtn").addEventListener("click", async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    const video = document.getElementById("webcam");
    video.srcObject = stream;
    
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("hud").style.display = "block"; // Mostra a interface
    
    function processVideo() {
        if (video.readyState >= 2) hands.send({ image: video });
        requestAnimationFrame(processVideo);
    }
    processVideo();
    animate(); 
});

obj.addEventListener('model-error', () => {
    document.getElementById("status-box").innerText = "FALHA NO ARQUIVO .GLB";
    document.getElementById("status-box").style.borderColor = "red";
    document.getElementById("status-box").style.color = "red";
});
</script>

</body>
</html>
