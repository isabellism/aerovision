<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ORBITA - Rosqueamento VR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; display: flex; width: 100vw; height: 100vh; }
        .viewport { flex: 1; height: 100vh; position: relative; overflow: hidden; border-right: 1px solid #333; }
        video.webcam { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; pointer-events: none; }
        a-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        #start-btn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px 40px; background: #00AAFF; color: white; border: none; border-radius: 12px; z-index: 10000; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <button id="start-btn">INICIAR MONTAGEM (SEM ALERTAS)</button>

    <div class="viewport">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-entity id="cam-l" camera position="-0.035 1.6 0" look-controls="enabled: false">
                <a-entity position="0.035 0 0">
                    <a-text class="action-txt" value="MAO LIVRE" position="0 0.6 -2" align="center" width="2.5" color="#FFF"></a-text>
                    <a-sphere class="cursor" radius="0.03" color="#FF0055" position="10 10 -1.5"></a-sphere>
                </a-entity>
            </a-entity>

            <a-entity position="0 1 -2.5">
                <a-cylinder radius="0.04" height="0.6" position="0 -0.2 0" color="#AAAAAA"></a-cylinder>
                <a-torus position="0 -0.5 0" radius="0.1" radius-tubular="0.04" color="#AAAAAA" rotation="90 0 0"></a-torus> <a-torus class="obj-porca" radius="0.08" radius-tubular="0.03" position="-0.5 0.3 0" color="#FFD700"></a-torus>
            </a-entity>
            <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>
            <a-light type="ambient" intensity="0.6"></a-light>
        </a-scene>
    </div>

    <div class="viewport" style="border-right: none;">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-entity id="cam-r" camera position="0.035 1.6 0" look-controls="enabled: false">
                <a-entity position="-0.035 0 0">
                    <a-text class="action-txt" value="MAO LIVRE" position="0 0.6 -2" align="center" width="2.5" color="#FFF"></a-text>
                    <a-sphere class="cursor" radius="0.03" color="#FF0055" position="10 10 -1.5"></a-sphere>
                </a-entity>
            </a-entity>

            <a-entity position="0 1 -2.5">
                <a-cylinder radius="0.04" height="0.6" position="0 -0.2 0" color="#AAAAAA"></a-cylinder>
                <a-torus position="0 -0.5 0" radius="0.1" radius-tubular="0.04" color="#AAAAAA" rotation="90 0 0"></a-torus>
                
                <a-torus class="obj-porca" radius="0.08" radius-tubular="0.03" position="-0.5 0.3 0" color="#FFD700"></a-torus>
            </a-entity>
            <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>
            <a-light type="ambient" intensity="0.6"></a-light>
        </a-scene>
    </div>

    <script>
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        // Constantes do Parafuso Virtual
        const PARAFUSO_X = 0;
        const TOPO_Y = 0.15; // Altura onde a porca encaixa no topo
        const BASE_Y = -0.4; // Altura onde a rosca acaba

        let state = {
            curX: -0.5, curY: 0.3, curRot: 0,
            tarX: -0.5, tarY: 0.3, tarRot: 0
        };

        let isSnapped = false;
        let isManipulating = false;
        let lastHandAngle = 0;
        let lastPinchTime = 0;
        let wasPinching = false;

        hands.onResults((res) => {
            if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) {
                document.querySelectorAll('.cursor').forEach(c => c.setAttribute('position', `10 10 -1.5`));
                updateHUD("MAO LIVRE", "#FFF");
                isManipulating = false; wasPinching = false; return;
            }

            const h = res.multiHandLandmarks[0];
            const x = (h[8].x - 0.5) * 4; 
            const y = (0.5 - h[8].y) * 3;
            document.querySelectorAll('.cursor').forEach(c => c.setAttribute('position', `${x} ${y} -1.5`));

            const distThumbIndex = Math.hypot(h[4].x - h[8].x, h[4].y - h[8].y);
            const distThumbMiddle = Math.hypot(h[4].x - h[12].x, h[4].y - h[12].y);
            const isPinch = distThumbIndex < 0.08 && distThumbMiddle > 0.1; 
            const isThreeFingers = distThumbIndex < 0.08 && distThumbMiddle < 0.08; 

            // DUPLO CLIQUE PARA RESETAR (Desmontar a peça)
            if (isPinch && !wasPinching) {
                let now = Date.now();
                if (now - lastPinchTime < 600) {
                    isSnapped = false;
                    state.tarX = -0.5; state.tarY = 0.3; state.tarRot = 0;
                    updateHUD("PECA DESMONTADA", "#FF4B4B");
                    lastPinchTime = 0; wasPinching = true; return; 
                } else { lastPinchTime = now; }
            }
            wasPinching = isPinch;

            let currentHandAngle = Math.atan2(h[17].y - h[5].y, h[17].x - h[5].x);

            // FASE 1: PEGAR E ENCAIXAR
            if (!isSnapped) {
                if (isPinch) {
                    state.tarX = x; state.tarY = y;
                    updateHUD("ALINHE NO TOPO", "#00AAFF");
                    
                    // Checa se a porca chegou no topo do parafuso
                    if (Math.hypot(state.tarX - PARAFUSO_X, state.tarY - TOPO_Y) < 0.2) {
                        isSnapped = true;
                        state.tarX = PARAFUSO_X; state.tarY = TOPO_Y; state.tarRot = 0;
                        updateHUD("TRAVADO! USE 3 DEDOS PARA GIRAR", "#32CD32");
                    }
                } else {
                    updateHUD("PEGUE A PORCA (2 DEDOS)", "#FFF");
                }
            } 
            // FASE 2: ROSQUEAR
            else {
                if (isThreeFingers) {
                    if (!isManipulating) {
                        isManipulating = true;
                        lastHandAngle = currentHandAngle;
                        updateHUD("APERTANDO PARAFUSO...", "#FFD700");
                    }

                    // Calcula o giro da mão
                    let angleDelta = currentHandAngle - lastHandAngle;
                    if (angleDelta > Math.PI) angleDelta -= 2 * Math.PI;
                    if (angleDelta < -Math.PI) angleDelta += 2 * Math.PI;

                    state.tarRot -= (angleDelta * (180 / Math.PI) * 2.0);
                    
                    // Desce a porca de acordo com o giro
                    let roscaY = TOPO_Y - (state.tarRot / 360) * 0.08; 
                    
                    if (roscaY > TOPO_Y) { roscaY = TOPO_Y; state.tarRot = 0; }
                    if (roscaY < BASE_Y) { roscaY = BASE_Y; updateHUD("PARAFUSO APERTADO MÁXIMO", "#32CD32");}
                    
                    state.tarY = roscaY;
                    lastHandAngle = currentHandAngle;
                } else {
                    isManipulating = false;
                    updateHUD("GIRE COM 3 DEDOS", "#32CD32");
                }
            }
        });

        // LOOP DE FÍSICA SUAVE
        const smooth = 0.15;
        function physicsLoop() {
            state.curX += (state.tarX - state.curX) * smooth;
            state.curY += (state.tarY - state.curY) * smooth;
            state.curRot += (state.tarRot - state.curRot) * smooth;

            document.querySelectorAll('.obj-porca').forEach(el => {
                el.setAttribute('position', `${state.curX} ${state.curY} 0`);
                el.setAttribute('rotation', `90 0 ${state.curRot}`); // Mantém a porca deitada
            });
            requestAnimationFrame(physicsLoop);
        }
        physicsLoop();

        function updateHUD(txt, color) { document.querySelectorAll('.action-txt').forEach(el => { el.setAttribute('value', txt); el.setAttribute('color', color); }); }

        document.getElementById('start-btn').addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.querySelectorAll('.webcam').forEach(v => { v.srcObject = stream; v.play(); });
            document.getElementById('start-btn').style.display = 'none';
            const vid = document.querySelectorAll('.webcam')[0];
            function run() { if (vid.readyState >= 2) hands.send({image: vid}); requestAnimationFrame(run); }
            run();
        });
    </script>
</body>
</html>
