<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AeroVision 2.1 - Final Ops</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; display: flex; }
        .viewport { width: 50vw; height: 100vh; position: relative; overflow: hidden; border-right: 1px solid #333; }
        video.webcam { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; transform: translate(-50%, -50%); object-fit: cover; z-index: 1; }
        a-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; }
        #btn-start { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px; background: #00AAFF; color: white; border: none; border-radius: 15px; z-index: 10000; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <button id="btn-start">INICIAR AERovision</button>

    <div class="viewport">
        <video class="webcam" id="v1" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-sphere id="res-l" position="-1.2 1.1 -2.5" radius="0.1" color="red"><a-text value="RESET" align="center" position="0 -0.2 0" width="2"></a-text></a-sphere>
            <a-text id="txt-l" value="ESCOLHA O MODO" position="0 0.9 -2.5" align="center" width="2.5"></a-text>
            
            <a-box id="m-learn-l" position="-0.5 0.3 -2" scale="0.4 0.2 0.1" color="#00AAFF"><a-text value="APRENDIZADO" align="center" width="2"></a-text></a-box>
            <a-box id="m-sim-l" position="0.5 0.3 -2" scale="0.4 0.2 0.1" color="#FFD700"><a-text value="SIMULADO" align="center" width="2" color="black"></a-text></a-box>

            <a-entity id="p1-l" position="-0.6 0 -2.5" rotation="0 0 90" visible="false"><a-cylinder id="c1-l" color="#777" height="0.6" radius="0.05"></a-cylinder></a-entity>
            <a-entity id="p2-l" position="-0.6 -0.4 -2.5" visible="false"><a-torus id="c2-l" color="#00AAFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0"></a-torus></a-entity>
            
            <a-entity id="b1-l" position="0.6 -0.2 -2.5" rotation="0 0 90" visible="false"><a-cylinder color="#FFF" height="0.6" radius="0.06" opacity="0.2"></a-cylinder></a-entity>
            <a-entity id="b2-l" position="0.6 -0.2 -2.5" visible="false"><a-torus color="#FFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0" opacity="0.2"></a-torus></a-entity>

            <a-sphere id="f-l" radius="0.05" color="red" position="10 10 10"></a-sphere>
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <div class="viewport" style="border-right: none;">
        <video class="webcam" id="v2" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-sphere id="res-r" position="-1.2 1.1 -2.5" radius="0.1" color="red"><a-text value="RESET" align="center" position="0 -0.2 0" width="2"></a-text></a-sphere>
            <a-text id="txt-r" value="ESCOLHA O MODO" position="0 0.9 -2.5" align="center" width="2.5"></a-text>
            <a-box id="m-learn-r" position="-0.5 0.3 -2" scale="0.4 0.2 0.1" color="#00AAFF"><a-text value="APRENDIZADO" align="center" width="2"></a-text></a-box>
            <a-box id="m-sim-r" position="0.5 0.3 -2" scale="0.4 0.2 0.1" color="#FFD700"><a-text value="SIMULADO" align="center" width="2" color="black"></a-text></a-box>
            <a-entity id="p1-r" position="-0.6 0 -2.5" rotation="0 0 90"><a-cylinder id="c1-r" color="#777" height="0.6" radius="0.05"></a-cylinder></a-entity>
            <a-entity id="b1-r" position="0.6 -0.2 -2.5" rotation="0 0 90"><a-cylinder color="#FFF" height="0.6" radius="0.06" opacity="0.2"></a-cylinder></a-entity>
            <a-entity id="p2-r" position="-0.6 -0.4 -2.5" visible="false"><a-torus id="c2-r" color="#00AAFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0"></a-torus></a-entity>
            <a-entity id="b2-r" position="0.6 -0.2 -2.5" visible="false"><a-torus color="#FFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0" opacity="0.2"></a-torus></a-entity>
            <a-sphere id="f-r" radius="0.05" color="red" position="10 10 10"></a-sphere>
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <script>
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        let currentMode = null; 
        let currentStep = 0; // 0=Menu, 1=P1, 2=P2
        let isGrabbing = false;
        let pos = { p1: {x:-0.7, y:0}, p2: {x:-0.7, y:-0.4} };
        const targetPos = { x: 0.7, y: -0.2 };

        hands.onResults((res) => {
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const h = res.multiHandLandmarks[0];
                const x = (h[8].x - 0.5) * 4; const y = (0.5 - h[8].y) * 2.8;
                const p = Math.sqrt(Math.pow(h[4].x - h[8].x, 2) + Math.pow(h[4].y - h[8].y, 2));
                
                document.querySelectorAll('.cursor-hand, [id^="f-"]').forEach(f => f.setAttribute('position', `${x} ${y} -2.2`));

                // RESET LOGIC
                if (x < -1 && y > 0.9 && p < 0.1) resetGame();

                // MENU LOGIC
                if (currentStep === 0) {
                    if (p < 0.1) {
                        if (x < 0) startMode('learning');
                        else if (x > 0) startMode('sim');
                    }
                    return;
                }

                // PLAY LOGIC
                const active = currentStep === 1 ? 'p1' : 'p2';
                const dist = Math.sqrt(Math.pow(x - pos[active].x, 2) + Math.pow(y - pos[active].y, 2));
                const distToTarget = Math.sqrt(Math.pow(x - targetPos.x, 2) + Math.pow(y - targetPos.y, 2));

                if (p < 0.1 && dist < 0.4) {
                    isGrabbing = true;
                    pos[active].x = x; pos[active].y = y;
                    updateVisuals(active, x, y);
                } else if (isGrabbing) {
                    isGrabbing = false;
                    if (distToTarget < 0.35) {
                        snap(active);
                    } else {
                        error(active);
                    }
                }
            }
        });

        function startMode(m) {
            currentMode = m; currentStep = 1;
            document.querySelectorAll('[id^="m-"]').forEach(el => el.setAttribute('visible', 'false'));
            document.querySelectorAll('[id^="txt-"]').forEach(t => t.setAttribute('value', 'PASSO 1: O EIXO'));
            document.querySelectorAll('[id^="p1-"], [id^="b1-"]').forEach(el => el.setAttribute('visible', 'true'));
            if (m === 'sim') document.querySelectorAll('[id^="p2-"]').forEach(el => el.setAttribute('visible', 'true'));
        }

        function updateVisuals(id, x, y) {
            document.querySelectorAll(`[id^="${id}-"]`).forEach(el => el.setAttribute('position', `${x} ${y} -2.5`));
        }

        function snap(id) {
            document.querySelectorAll(`[id^="${id}-"]`).forEach(el => {
                el.setAttribute('position', `${targetPos.x} ${targetPos.y} -2.5`);
                el.querySelector('*').setAttribute('color', '#32CD32');
            });
            if (currentStep === 1) {
                currentStep = 2;
                document.querySelectorAll('[id^="txt-"]').forEach(t => t.setAttribute('value', 'PASSO 2: A CARCACA'));
                document.querySelectorAll('[id^="p2-"], [id^="b2-"]').forEach(el => el.setAttribute('visible', 'true'));
            } else {
                document.querySelectorAll('[id^="txt-"]').forEach(t => t.setAttribute('value', 'MISSAO COMPLETA!'));
            }
        }

        function error(id) {
            document.querySelectorAll('[id^="txt-"]').forEach(t => { t.setAttribute('value', 'ERRO! POSICAO ERRADA'); t.setAttribute('color', 'red'); });
            const oldPos = id === 'p1' ? {x:-0.7, y:0} : {x:-0.7, y:-0.4};
            pos[id] = {...oldPos};
            updateVisuals(id, oldPos.x, oldPos.y);
            setTimeout(() => {
                document.querySelectorAll('[id^="txt-"]').forEach(t => t.setAttribute('color', 'white'));
            }, 1000);
        }

        function resetSimulation() {
            // Esta função substitui o reload para ser hands-free
            currentStep = 0; isGrabbing = false; isSnapped = false;
            pos = { p1: {x:-0.7, y:0}, p2: {x:-0.7, y:-0.4} };
            document.querySelectorAll('[id^="m-"]').forEach(el => el.setAttribute('visible', 'true'));
            document.querySelectorAll('[id^="p1-"], [id^="p2-"], [id^="b1-"], [id^="b2-"]').forEach(el => el.setAttribute('visible', 'false'));
            document.querySelectorAll('[id^="txt-"]').forEach(t => t.setAttribute('value', 'ESCOLHA O MODO'));
            document.getElementById('c1-left').setAttribute('color', '#777');
            document.getElementById('c1-right').setAttribute('color', '#777');
            document.getElementById('c2-left').setAttribute('color', '#00AAFF');
            document.getElementById('c2-right').setAttribute('color', '#00AAFF');
        }

        const btnStart = document.getElementById('btn-start');
        btnStart.addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.querySelectorAll('.webcam').forEach(v => { v.srcObject = stream; v.play(); });
            btnStart.style.display = 'none';
            function run() { if (videos[0].readyState >= 2) hands.send({image: videos[0]}); requestAnimationFrame(run); }
            setTimeout(run, 1000);
        });
    </script>
</body>
</html>
