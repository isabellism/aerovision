<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ORBITA - Mecânica de Montagem</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Share Tech Mono', monospace; user-select: none; }
    video { display: none; }
    
    #startBtn {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        padding: 20px 40px; background: rgba(0, 170, 255, 0.2); border: 2px solid #00AAFF;
        color: #00AAFF; font-size: 18px; border-radius: 5px; z-index: 9999;
        cursor: pointer; text-transform: uppercase; box-shadow: 0 0 15px rgba(0, 170, 255, 0.5);
    }
    #startBtn:active { background: #00AAFF; color: #000; }

    #hud {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        pointer-events: none; z-index: 1000; display: none; border: 2px solid rgba(0, 170, 255, 0.3); box-sizing: border-box;
    }
    
    .hud-corner { position: absolute; width: 30px; height: 30px; border: 3px solid #00AAFF; }
    .tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .tr { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .bl { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    #status-box {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6); border: 1px solid #00AAFF; padding: 10px 20px;
        color: #00AAFF; font-size: 1.2rem; text-align: center; text-shadow: 0 0 5px #00AAFF;
    }

    #telemetry {
        position: absolute; bottom: 20px; left: 20px;
        background: rgba(0, 0, 0, 0.5); border-left: 3px solid #00AAFF; padding: 10px; color: #fff; line-height: 1.5;
    }
    .val { color: #00AAFF; font-weight: bold; }
    
    /* Botão de Reset no HUD */
    #reset-btn {
        position: absolute; bottom: 20px; right: 20px; pointer-events: auto;
        padding: 10px 20px; background: rgba(255, 0, 85, 0.2); border: 1px solid #FF0055;
        color: #FF0055; font-family: 'Share Tech Mono', monospace; cursor: pointer;
    }
</style>
</head>

<body>

<button id="startBtn">INICIAR PROTÓTIPO DE MONTAGEM</button>

<div id="hud">
    <div class="hud-corner tl"></div><div class="hud-corner tr"></div>
    <div class="hud-corner bl"></div><div class="hud-corner br"></div>
    <div id="status-box">SCANNER ATIVO</div>
    <div id="telemetry">
        <div>OPERAÇÃO: <span id="modo-txt" class="val">BUSCANDO MÃO</span></div>
        <div>TORQUE (Giro): <span id="rot-txt" class="val">0.0°</span></div>
        <div>PROFUNDIDADE: <span id="depth-txt" class="val">0.0 mm</span></div>
    </div>
    <button id="reset-btn" onclick="resetMontagem()">DESMONTAR PEÇA</button>
</div>

<video id="webcam" autoplay playsinline muted></video>

<a-scene embedded vr-mode-ui="enabled:false">
    <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera look-controls="enabled: false"></a-camera>
        <a-sphere id="cursor" radius="0.02" color="#FF0055" position="10 10 -1.5" material="emissive: #FF0055; emissiveIntensity: 2"></a-sphere>
    </a-entity>

    <a-light type="ambient" color="#224455" intensity="1.5"></a-light>
    <a-light type="directional" color="#ffffff" position="1 3 2" intensity="2.0"></a-light>

    <a-entity position="0 1 -2.5">
        <a-cylinder radius="0.8" height="0.02" position="0 -0.5 0" color="#00AAFF" wireframe="true" opacity="0.3"></a-cylinder>
        
        <a-cylinder id="parafuso-mesh" radius="0.04" height="0.8" position="0 -0.1 0" color="#888888" metalness="0.8" roughness="0.2"></a-cylinder>
        
        <a-torus id="porca-mesh" radius="0.08" radius-tubular="0.02" position="-0.5 0.3 0" color="#FFD700" metalness="1" roughness="0.1"></a-torus>
    </a-entity>
</a-scene>

<script>
const hands = new Hands({ locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

const porcaObj = document.querySelector("#porca-mesh");
const cursor = document.querySelector("#cursor");
const hudStatus = document.getElementById("status-box");
const txtModo = document.getElementById("modo-txt");
const txtRot = document.getElementById("rot-txt");
const txtDepth = document.getElementById("depth-txt");

// CONSTANTES DO PARAFUSO (Coordenadas reais do A-Frame)
const PARAFUSO_X = 0;
const PARAFUSO_TOPO_Y = 0.3; // Altura máxima para encaixar
const PARAFUSO_BASE_Y = -0.4; // Fim da rosca

let state = {
    curX: -0.5, curY: 0.3, curRot: 0,
    tarX: -0.5, tarY: 0.3, tarRot: 0
};

let isSnapped = false; // Se a porca está no eixo do parafuso
let isManipulating = false;
let lastHandAngle = 0;

hands.onResults(results => {
    if (!results.multiHandLandmarks) {
        cursor.setAttribute("position", `10 10 -1.5`);
        txtModo.innerText = "STANDBY"; txtModo.style.color = "#888";
        hudStatus.style.borderColor = "#00AAFF"; hudStatus.style.boxShadow = "0 0 5px #00AAFF";
        isManipulating = false;
        return;
    }

    const hand = results.multiHandLandmarks[0];
    const x = (hand[8].x - 0.5) * 4;
    const y = (0.5 - hand[8].y) * 3;
    cursor.setAttribute("position", `${x} ${y} -1.5`);

    const pinchDist = Math.hypot(hand[4].x - hand[8].x, hand[4].y - hand[8].y);
    const middleDist = Math.hypot(hand[4].x - hand[12].x, hand[4].y - hand[12].y);

    const isPinching = pinchDist < 0.08 && middleDist > 0.1; 
    const isThreeFingers = pinchDist < 0.08 && middleDist < 0.08; 

    // CALCULANDO O ÂNGULO DA MÃO CONTINUAMENTE PARA ROTAÇÃO 
    let currentHandAngle = Math.atan2(hand[17].y - hand[5].y, hand[17].x - hand[5].x);

    // ESTÁGIO 1: MOVER LIVREMENTE (Até encaixar)
    if (!isSnapped) {
        if (isPinching) {
            state.tarX = x; state.tarY = y;
            txtModo.innerText = "MOVENDO PORCA"; txtModo.style.color = "#FF0055";
            hudStatus.innerText = "ALINHE AO TOPO DO PARAFUSO";
            
            // Checar se chegou perto do topo do parafuso
            const distToTop = Math.hypot(state.tarX - PARAFUSO_X, state.tarY - PARAFUSO_TOPO_Y);
            if (distToTop < 0.15) {
                // TRAVOU NO EIXO!
                isSnapped = true;
                state.tarX = PARAFUSO_X;
                state.tarY = PARAFUSO_TOPO_Y;
                state.tarRot = 0;
                hudStatus.innerText = "EIXO ALINHADO";
                hudStatus.style.borderColor = "#32CD32"; hudStatus.style.color = "#32CD32";
            }
        } else {
            txtModo.innerText = "AGUARDANDO AÇÃO"; txtModo.style.color = "#00AAFF";
        }
    } 
    // ESTÁGIO 2: ROSQUEAR (Eixo travado)
    else {
        if (isThreeFingers) {
            if (!isManipulating) {
                isManipulating = true;
                lastHandAngle = currentHandAngle;
                hudStatus.innerText = "ROSQUEANDO...";
                hudStatus.style.borderColor = "#FFD700"; hudStatus.style.color = "#FFD700";
                txtModo.innerText = "APLICANDO TORQUE"; txtModo.style.color = "#FFD700";
            }

            // Descobrir o quanto a mão girou (Delta Angle)
            let angleDelta = currentHandAngle - lastHandAngle;
            // Correção caso o ângulo pule de 180 para -180
            if (angleDelta > Math.PI) angleDelta -= 2 * Math.PI;
            if (angleDelta < -Math.PI) angleDelta += 2 * Math.PI;

            // Aplica a rotação (Multiplicador de sensibilidade)
            state.tarRot -= (angleDelta * (180 / Math.PI) * 2.0);
            
            // A MATEMÁTICA DO PASSO DE ROSCA: Desce o Y baseado no Giro
            // Cada 360 graus desce 0.05 no eixo Y
            let roscaY = PARAFUSO_TOPO_Y - (state.tarRot / 360) * 0.05;
            
            // Limita a porca para não passar do parafuso
            if (roscaY > PARAFUSO_TOPO_Y) { roscaY = PARAFUSO_TOPO_Y; state.tarRot = 0; }
            if (roscaY < PARAFUSO_BASE_Y) { roscaY = PARAFUSO_BASE_Y; }
            
            state.tarY = roscaY;
            lastHandAngle = currentHandAngle;

        } else {
            isManipulating = false;
            hudStatus.innerText = "EIXO ALINHADO"; hudStatus.style.color = "#32CD32";
            txtModo.innerText = "USE 3 DEDOS PARA GIRAR"; txtModo.style.color = "#32CD32";
        }
    }
});

function resetMontagem() {
    isSnapped = false;
    state.tarX = -0.5; state.tarY = 0.3; state.tarRot = 0;
    hudStatus.innerText = "SCANNER ATIVO"; hudStatus.style.borderColor = "#00AAFF"; hudStatus.style.color = "#00AAFF";
}

const smooth = 0.15;
function animate() {
    state.curX += (state.tarX - state.curX) * smooth;
    state.curY += (state.tarY - state.curY) * smooth;
    state.curRot += (state.tarRot - state.curRot) * smooth;

    porcaObj.setAttribute("position", `${state.curX} ${state.curY} 0`);
    porcaObj.setAttribute("rotation", `90 0 ${state.curRot}`); // Deixei 90 no X para o anel ficar deitado

    // Atualiza HUD
    txtRot.innerText = Math.abs(state.curRot).toFixed(1) + "°";
    // Calcula profundidade em milímetros fictícios (De 0 a 100mm)
    let percentual = (PARAFUSO_TOPO_Y - state.curY) / (PARAFUSO_TOPO_Y - PARAFUSO_BASE_Y);
    txtDepth.innerText = (percentual * 100).toFixed(1) + " mm";

    requestAnimationFrame(animate);
}

document.getElementById("startBtn").addEventListener("click", async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    const video = document.getElementById("webcam");
    video.srcObject = stream;
    
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("hud").style.display = "block";
    
    function processVideo() {
        if (video.readyState >= 2) hands.send({ image: video });
        requestAnimationFrame(processVideo);
    }
    processVideo(); animate(); 
});
</script>

</body>
</html>
