<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AeroVision 3.0 - Spatial AR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #start-btn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px; background: #00AAFF; color: white; border: none; border-radius: 15px; z-index: 10000; font-weight: bold; }
        /* Ajuste para visão estereoscópica (Cardboard) no AR.js */
        .a-canvas { width: 100% !important; height: 100% !important; left: 0 !important; }
    </style>
</head>
<body>

    <button id="start-btn">INICIAR RASTREIO ESPACIAL</button>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
        
        <a-marker preset="hiro">
            
            <a-entity position="0 1.5 0" rotation="-90 0 0">
                <a-text id="txt-status" value="APONTE PARA O MARCADOR" align="center" width="3" color="#FFF"></a-text>
            </a-entity>

            <a-entity id="menu-area" position="0 0.5 0" rotation="-90 0 0">
                <a-box id="btn-learn" position="-0.4 0 0" scale="0.3 0.2 0.1" color="#00AAFF">
                    <a-text value="ENSINO" align="center" position="0 0 0.6" width="2"></a-text>
                </a-box>
                <a-box id="btn-sim" position="0.4 0 0" scale="0.3 0.2 0.1" color="#FFD700">
                    <a-text value="SIMULADO" align="center" position="0 0 0.6" width="2" color="black"></a-text>
                </a-box>
            </a-entity>

            <a-entity id="p1" position="-0.5 0.1 0" rotation="0 0 0" visible="false">
                <a-cylinder color="#777" height="0.4" radius="0.04"></a-cylinder>
            </a-entity>
            <a-entity id="b1" position="0.3 0.1 0" rotation="0 0 0" visible="false">
                <a-cylinder color="#FFF" height="0.4" radius="0.05" opacity="0.3"></a-cylinder>
            </a-entity>

            <a-entity id="p2" position="-0.5 0.1 0.4" visible="false">
                <a-torus color="#0066FF" radius="0.15" radius-tubular="0.01" rotation="90 0 0"></a-torus>
            </a-entity>
        </a-marker>

        <a-entity camera>
            <a-sphere id="hand-pointer" radius="0.03" color="red" position="0 0 -1"></a-sphere>
        </a-entity>

    </a-scene>

    <script>
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

        let state = "MENU";
        let isGrabbing = false;
        let activePiece = null;
        let p1Pos = {x: -0.5, y: 0.1, z: 0};
        
        hands.onResults((res) => {
            if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) return;

            const h = res.multiHandLandmarks[0];
            // Mapeamento da mão para coordenadas 3D (ajustado para AR)
            const x = (h[8].x - 0.5) * 2;
            const y = (0.5 - h[8].y) * 2;
            const pinch = Math.sqrt(Math.pow(h[4].x - h[8].x, 2) + Math.pow(h[4].y - h[8].y, 2));

            document.getElementById('hand-pointer').setAttribute('position', `${x} ${y} -1`);

            if (state === "MENU" && pinch < 0.1) {
                if (x < 0) startMode("learn");
                else if (x > 0) startMode("sim");
            }

            if (state === "PLAY" && pinch < 0.08) {
                // Lógica de arrastar peça (simplificada para o marcador)
                // Aqui a lógica detecta se sua mão está "perto" da peça no marcador
            }
        });

        function startMode(m) {
            state = "PLAY";
            document.getElementById('menu-area').setAttribute('visible', 'false');
            document.getElementById('txt-status').setAttribute('value', m === "learn" ? "MODO ENSINO" : "MODO SIMULADO");
            document.getElementById('p1').setAttribute('visible', 'true');
            document.getElementById('b1').setAttribute('visible', 'true');
        }

        function resetSimulation() {
            // Reset suave como pedido
            state = "MENU";
            document.getElementById('menu-area').setAttribute('visible', 'true');
            document.getElementById('p1').setAttribute('visible', 'false');
            document.getElementById('p2').setAttribute('visible', 'false');
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-btn').style.display = 'none';
            // O AR.js já gerencia a webcam, apenas conectamos a IA ao vídeo que ele cria
            const video = document.querySelector('video');
            function run() { 
                if (video && video.readyState >= 2) hands.send({image: video}); 
                requestAnimationFrame(run); 
            }
            run();
        });
    </script>
</body>
</html>
