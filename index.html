<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AeroVision 1.3.1 - Error Logic</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; display: flex; }
        .viewport { width: 50vw; height: 100vh; position: relative; overflow: hidden; border-right: 1px solid #333; }
        video.webcam { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; transform: translate(-50%, -50%); object-fit: cover; z-index: 1; }
        a-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; }
        #btn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: #00AAFF; color: white; border: none; border-radius: 10px; z-index: 9999; font-weight: bold; cursor: pointer;}
    </style>
</head>
<body>

    <button id="btn">INICIAR TREINO 1.3.1</button>

    <div class="viewport">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-sphere id="reset-left" position="-0.7 0.7 -2" radius="0.08" color="#FF4B4B"></a-sphere>
            <a-text id="txt-left" value="PASSO 1: ENCAIXE O EIXO" position="0 0.8 -2.2" align="center" width="2.5"></a-text>
            
            <a-entity id="p1-left" position="-0.6 0 -2.5" rotation="0 0 90">
                <a-cylinder id="c1-left" color="#777" height="0.6" radius="0.05"></a-cylinder>
            </a-entity>
            <a-entity id="b1-left" position="0.6 -0.2 -2.5" rotation="0 0 90">
                <a-cylinder color="#FFF" height="0.6" radius="0.06" opacity="0.2"></a-cylinder>
            </a-entity>

            <a-entity id="p2-left" position="-0.6 0 -2.5" visible="false">
                <a-torus id="c2-left" color="#00AAFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0"></a-torus>
            </a-entity>
            <a-entity id="b2-left" position="0.6 -0.2 -2.5" visible="false">
                <a-torus color="#FFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0" opacity="0.2"></a-torus>
            </a-entity>

            <a-sphere id="finger-left" radius="0.05" color="red" position="10 10 10"></a-sphere>
            <a-light type="ambient" intensity="1.2"></a-light>
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <div class="viewport" style="border-right: none;">
        <video class="webcam" autoplay playsinline muted></video>
        <a-scene embedded vr-mode-ui="enabled: false">
            <a-sphere id="reset-right" position="-0.7 0.7 -2" radius="0.08" color="#FF4B4B"></a-sphere>
            <a-text id="txt-right" value="PASSO 1: ENCAIXE O EIXO" position="0 0.8 -2.2" align="center" width="2.5"></a-text>
            <a-entity id="p1-right" position="-0.6 0 -2.5" rotation="0 0 90"><a-cylinder id="c1-right" color="#777" height="0.6" radius="0.05"></a-cylinder></a-entity>
            <a-entity id="b1-right" position="0.6 -0.2 -2.5" rotation="0 0 90"><a-cylinder color="#FFF" height="0.6" radius="0.06" opacity="0.2"></a-cylinder></a-entity>
            <a-entity id="p2-right" position="-0.6 0 -2.5" visible="false"><a-torus id="c2-right" color="#00AAFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0"></a-torus></a-entity>
            <a-entity id="b2-right" position="0.6 -0.2 -2.5" visible="false"><a-torus color="#FFF" radius="0.25" radius-tubular="0.02" rotation="90 0 0" opacity="0.2"></a-torus></a-entity>
            <a-sphere id="finger-right" radius="0.05" color="red" position="10 10 10"></a-sphere>
            <a-light type="ambient" intensity="1.2"></a-light>
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>

    <script>
        const btn = document.getElementById('btn');
        const videos = document.querySelectorAll('.webcam');
        const fingers = [document.getElementById('finger-left'), document.getElementById('finger-right')];
        const texts = [document.getElementById('txt-left'), document.getElementById('txt-right')];
        
        let currentStep = 1;
        let isGrabbing = false;
        let isSnapped = false;
        const initialPos = { x: -0.6, y: 0, z: -2.5 };
        let partPos = { ...initialPos };
        const basePos = { x: 0.6, y: -0.2, z: -2.5 };

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const index = hand[8];
                const thumb = hand[4];
                
                const posX = (index.x - 0.5) * 3.5; 
                const posY = (0.5 - index.y) * 2.5;
                const pinch = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));
                
                fingers.forEach(f => f.setAttribute('position', `${posX} ${posY} -2.2`));

                // Reset Virtual
                if (posX < -0.5 && posY > 0.5 && pinch < 0.1) resetSimulation();

                if (!isSnapped) {
                    handleStep(posX, posY, pinch);
                }
            }
        });

        function handleStep(x, y, p) {
            const prefix = currentStep === 1 ? 'p1' : 'p2';
            const baseId = currentStep === 1 ? 'b1' : 'b2';
            const distToPart = Math.sqrt(Math.pow(x - partPos.x, 2) + Math.pow(y - partPos.y, 2));
            const targets = [document.getElementById(prefix + '-left'), document.getElementById(prefix + '-right')];
            const bases = [document.getElementById(baseId + '-left'), document.getElementById(baseId + '-right')];

            // 1. Monitorizar Proximidade para Brilho
            const distToBase = Math.sqrt(Math.pow(partPos.x - basePos.x, 2) + Math.pow(partPos.y - basePos.y, 2));
            if (isGrabbing && distToBase < 0.6) {
                bases.forEach(b => b.querySelector('*').setAttribute('color', '#FFD700')); // Alvo brilha em amarelo
            } else {
                bases.forEach(b => b.querySelector('*').setAttribute('color', '#FFF'));
            }

            // 2. Lógica de Agarrar
            if (p < 0.1 && distToPart < 0.4) {
                isGrabbing = true;
                partPos.x = x; partPos.y = y;
                targets.forEach(t => t.setAttribute('position', `${x} ${y} ${partPos.z}`));
            } else if (isGrabbing) {
                isGrabbing = false;
                // 3. Lógica de Soltar: SNAP vs ERRO
                if (distToBase < 0.3) {
                    snapPiece(targets);
                } else {
                    triggerError(targets);
                }
            }
        }

        function triggerError(targets) {
            texts.forEach(t => {
                t.setAttribute('value', 'ERRO: POSICAO INCORRETA!');
                t.setAttribute('color', '#FF4B4B');
            });
            
            // Animacion de retorno ao inicio
            partPos = { ...initialPos };
            targets.forEach(t => t.setAttribute('position', `${initialPos.x} ${initialPos.y} ${initialPos.z}`));
            
            setTimeout(() => {
                if (!isSnapped) {
                    const msg = currentStep === 1 ? "PASSO 1: ENCAIXE O EIXO" : "PASSO 2: INSTALE A CARCACA";
                    texts.forEach(t => {
                        t.setAttribute('value', msg);
                        t.setAttribute('color', '#FFF');
                    });
                }
            }, 1500);
        }

        function snapPiece(targets) {
            isSnapped = true;
            targets.forEach(t => {
                t.setAttribute('position', `${basePos.x} ${basePos.y} -2.5`);
                const subPieceId = currentStep === 1 ? 'c1' : 'c2';
                document.getElementById(subPieceId + '-left').setAttribute('color', '#32CD32');
                document.getElementById(subPieceId + '-right').setAttribute('color', '#32CD32');
            });

            setTimeout(() => {
                if (currentStep === 1) {
                    currentStep = 2;
                    isSnapped = false;
                    partPos = { ...initialPos };
                    texts.forEach(t => t.setAttribute('value', 'PASSO 2: INSTALE A CARCACA'));
                    toggleVisibility(['p2', 'b2'], true);
                    toggleVisibility(['b1'], false);
                } else {
                    texts.forEach(t => t.setAttribute('value', 'MISSAO CONCLUIDA!'));
                }
            }, 800);
        }

        function resetSimulation() {
            location.reload(); // Simplificado para garantir limpeza total de estados de erro
        }

        function toggleVisibility(ids, state) {
            ids.forEach(id => {
                document.getElementById(id + '-left').setAttribute('visible', state);
                document.getElementById(id + '-right').setAttribute('visible', state);
            });
        }

        async function loop() {
            if (videos[0].readyState >= 2) await hands.send({image: videos[0]});
            requestAnimationFrame(loop);
        }

        btn.addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            videos.forEach(v => { v.srcObject = stream; v.play(); });
            btn.style.display = 'none';
            setTimeout(loop, 1000);
        });
    </script>
</body>
</html>
